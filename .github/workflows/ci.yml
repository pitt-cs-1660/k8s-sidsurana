name: Validate WordPress Deployment

on:
  push:
    branches: [main]
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Start minikube
        uses: medyagh/setup-minikube@latest

      - name: Delete existing deployments to avoid selector conflict
        run: |
          kubectl delete deployment wordpress --ignore-not-found
          kubectl delete deployment wordpress-mysql --ignore-not-found

      - name: Apply Kubernetes manifests
        run: kubectl apply -f manifests/

      - name: Wait for pods to be ready
        run: kubectl wait --for=condition=ready pod --all --timeout=180s

      - name: Run check.sh
        run: ./check.sh

